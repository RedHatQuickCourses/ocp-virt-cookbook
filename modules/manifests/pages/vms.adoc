= Virtual Machine Manifests
:navtitle: Virtual Machines

== Overview

This page provides complete VM manifest examples for different operating systems and use cases, including cloud-init configurations and network attachments.

== Basic VM Structure

A typical VM manifest includes:

* `dataVolumeTemplates` - Storage provisioning
* `runStrategy` - VM lifecycle management  
* `template.spec.domain` - VM hardware configuration
* `template.spec.networks` - Network attachments
* `template.spec.volumes` - Volume attachments

== Fedora VM Examples

=== Basic Fedora VM with DHCP

[source,yaml]
----
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: fedora-basic
  namespace: vms-prod
spec:
  dataVolumeTemplates:
    - apiVersion: cdi.kubevirt.io/v1beta1
      kind: DataVolume
      metadata:
        name: fedora-basic-disk
      spec:
        sourceRef:
          kind: DataSource
          name: fedora
          namespace: openshift-virtualization-os-images
        storage:
          resources:
            requests:
              storage: 30Gi
  runStrategy: Always
  template:
    metadata:
      labels:
        kubevirt.io/domain: fedora-basic
    spec:
      domain:
        cpu:
          cores: 2
        devices:
          disks:
            - disk:
                bus: virtio
              name: rootdisk
            - disk:
                bus: virtio
              name: cloudinitdisk
          interfaces:
            - masquerade: {}
              name: default
          rng: {}
        machine:
          type: pc-q35-rhel9.4.0
        memory:
          guest: 4Gi
      networks:
        - name: default
          pod: {}
      volumes:
        - dataVolume:
            name: fedora-basic-disk
          name: rootdisk
        - cloudInitNoCloud:
            userData: |-
              #cloud-config
              user: fedora
              password: fedora123
              chpasswd: { expire: False }
              ssh_pwauth: True
          name: cloudinitdisk
----

**Key Components:**

* Uses Fedora DataSource from cluster
* 2 vCPUs, 4Gi memory
* Masquerade interface (default pod network)
* Cloud-init with basic user configuration

=== Fedora VM with Multiple Networks

[source,yaml]
----
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: fedora-multi-network
  namespace: vms-prod
spec:
  dataVolumeTemplates:
    - apiVersion: cdi.kubevirt.io/v1beta1
      kind: DataVolume
      metadata:
        name: fedora-multi-network-disk
      spec:
        sourceRef:
          kind: DataSource
          name: fedora
          namespace: openshift-virtualization-os-images
        storage:
          resources:
            requests:
              storage: 30Gi
  runStrategy: Always
  template:
    metadata:
      labels:
        kubevirt.io/domain: fedora-multi-network
    spec:
      domain:
        cpu:
          cores: 4
        devices:
          disks:
            - disk:
                bus: virtio
              name: rootdisk
            - disk:
                bus: virtio
              name: cloudinitdisk
          interfaces:
            - masquerade: {}
              name: default
            - bridge: {}
              name: data-network
          rng: {}
        machine:
          type: pc-q35-rhel9.4.0
        memory:
          guest: 8Gi
      networks:
        - name: default
          pod: {}
        - name: data-network
          multus:
            networkName: localnet-vlan-100
      volumes:
        - dataVolume:
            name: fedora-multi-network-disk
          name: rootdisk
        - cloudInitNoCloud:
            userData: |-
              #cloud-config
              user: fedora
              password: fedora123
              chpasswd: { expire: False }
              ssh_pwauth: True
            networkData: |-
              version: 2
              ethernets:
                enp1s0:
                  dhcp4: true
                enp2s0:
                  dhcp4: false
                  dhcp6: false
                  addresses:
                    - 192.168.100.50/24
          name: cloudinitdisk
----

**Key Features:**

* Two network interfaces (pod network + VLAN)
* Static IP on secondary interface via cloud-init
* 4 vCPUs, 8Gi memory for higher workloads

**Related Tutorial:**

* xref:networking:localnet-vlan.adoc[Localnet Secondary Networks with VLAN using NAD]

== RHEL VM Examples

=== RHEL 9 VM

[source,yaml]
----
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: rhel9-vm
  namespace: vms-prod
spec:
  dataVolumeTemplates:
    - apiVersion: cdi.kubevirt.io/v1beta1
      kind: DataVolume
      metadata:
        name: rhel9-vm-disk
      spec:
        sourceRef:
          kind: DataSource
          name: rhel9
          namespace: openshift-virtualization-os-images
        storage:
          resources:
            requests:
              storage: 40Gi
  runStrategy: Always
  template:
    metadata:
      labels:
        kubevirt.io/domain: rhel9-vm
        app: database
        environment: production
    spec:
      domain:
        cpu:
          cores: 4
          sockets: 1
          threads: 1
        devices:
          disks:
            - disk:
                bus: virtio
              name: rootdisk
            - disk:
                bus: virtio
              name: cloudinitdisk
          interfaces:
            - masquerade: {}
              name: default
          rng: {}
        machine:
          type: pc-q35-rhel9.4.0
        memory:
          guest: 16Gi
      networks:
        - name: default
          pod: {}
      volumes:
        - dataVolume:
            name: rhel9-vm-disk
          name: rootdisk
        - cloudInitNoCloud:
            userData: |-
              #cloud-config
              user: cloud-user
              password: changeme
              chpasswd: { expire: True }
              ssh_pwauth: True
              packages:
                - vim
                - git
              runcmd:
                - systemctl enable --now cockpit.socket
          name: cloudinitdisk
----

**Key Features:**

* RHEL 9 DataSource
* Labels for organization (app, environment)
* Package installation via cloud-init
* Cockpit enabled for web management

=== RHEL with Additional Data Disk

[source,yaml]
----
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: rhel9-with-data-disk
  namespace: vms-prod
spec:
  dataVolumeTemplates:
    - apiVersion: cdi.kubevirt.io/v1beta1
      kind: DataVolume
      metadata:
        name: rhel9-with-data-disk-root
      spec:
        sourceRef:
          kind: DataSource
          name: rhel9
          namespace: openshift-virtualization-os-images
        storage:
          resources:
            requests:
              storage: 40Gi
    - apiVersion: cdi.kubevirt.io/v1beta1
      kind: DataVolume
      metadata:
        name: rhel9-with-data-disk-data
      spec:
        source:
          blank: {}
        storage:
          resources:
            requests:
              storage: 100Gi
  runStrategy: Always
  template:
    metadata:
      labels:
        kubevirt.io/domain: rhel9-with-data-disk
    spec:
      domain:
        cpu:
          cores: 4
        devices:
          disks:
            - disk:
                bus: virtio
              name: rootdisk
            - disk:
                bus: virtio
              name: datadisk
            - disk:
                bus: virtio
              name: cloudinitdisk
          interfaces:
            - masquerade: {}
              name: default
          rng: {}
        machine:
          type: pc-q35-rhel9.4.0
        memory:
          guest: 16Gi
      networks:
        - name: default
          pod: {}
      volumes:
        - dataVolume:
            name: rhel9-with-data-disk-root
          name: rootdisk
        - dataVolume:
            name: rhel9-with-data-disk-data
          name: datadisk
        - cloudInitNoCloud:
            userData: |-
              #cloud-config
              user: cloud-user
              password: changeme
              chpasswd: { expire: True }
              ssh_pwauth: True
          name: cloudinitdisk
----

**Key Features:**

* Two DataVolumes - root and data disks
* Blank data disk for application data
* Separate storage management

== Windows VM Example

=== Windows Server 2022

[source,yaml]
----
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: windows-2022
  namespace: vms-prod
spec:
  dataVolumeTemplates:
    - apiVersion: cdi.kubevirt.io/v1beta1
      kind: DataVolume
      metadata:
        name: windows-2022-disk
      spec:
        sourceRef:
          kind: DataSource
          name: win2k22
          namespace: openshift-virtualization-os-images
        storage:
          resources:
            requests:
              storage: 60Gi
  runStrategy: RerunOnFailure
  template:
    metadata:
      labels:
        kubevirt.io/domain: windows-2022
    spec:
      domain:
        cpu:
          cores: 4
          sockets: 1
          threads: 1
        devices:
          disks:
            - disk:
                bus: sata
              name: rootdisk
            - cdrom:
                bus: sata
              name: windows-guest-tools
          interfaces:
            - masquerade: {}
              model: e1000e
              name: default
          inputs:
            - bus: usb
              name: tablet
              type: tablet
          rng: {}
        features:
          acpi: {}
          apic: {}
          hyperv:
            relaxed: {}
            spinlocks:
              spinlocks: 8191
            vapic: {}
        machine:
          type: pc-q35-rhel9.4.0
        memory:
          guest: 16Gi
        resources:
          requests:
            memory: 16Gi
      networks:
        - name: default
          pod: {}
      volumes:
        - dataVolume:
            name: windows-2022-disk
          name: rootdisk
        - containerDisk:
            image: registry.redhat.io/container-native-virtualization/virtio-win-rhel9
          name: windows-guest-tools
----

**Key Features for Windows:**

* `bus: sata` for Windows compatibility
* `model: e1000e` network adapter
* Hyper-V enlightenments for better performance
* VirtIO drivers via container disk
* USB tablet for mouse input

**Note:** Windows VMs require valid licenses and proper guest tools installation.

== VM Lifecycle Management

=== Run Strategies

**Always:**
[source,yaml]
----
spec:
  runStrategy: Always
----
VM should always be running. Automatically restarts if stopped.

**RerunOnFailure:**
[source,yaml]
----
spec:
  runStrategy: RerunOnFailure
----
VM restarts only if it fails. Normal shutdown keeps it stopped.

**Manual:**
[source,yaml]
----
spec:
  runStrategy: Manual
----
VM lifecycle managed manually via virtctl or API.

**Halted:**
[source,yaml]
----
spec:
  runStrategy: Halted
----
VM should be stopped. Running VM will be shut down.

=== Start/Stop VMs

[source,bash,role=execute]
----
# Start VM
virtctl start <vm-name> -n <namespace>

# Stop VM (graceful)
virtctl stop <vm-name> -n <namespace>

# Restart VM
virtctl restart <vm-name> -n <namespace>

# Pause VM
virtctl pause vm <vm-name> -n <namespace>

# Unpause VM
virtctl unpause vm <vm-name> -n <namespace>
----

== VM Resource Management

=== CPU Configuration

[source,yaml]
----
spec:
  template:
    spec:
      domain:
        cpu:
          cores: 4
          sockets: 2
          threads: 1
          dedicatedCpuPlacement: false
          model: host-passthrough
----

**CPU Models:**

* `host-passthrough` - Pass through host CPU features
* `host-model` - Similar to host, filtered for migration
* Specific models - e.g., `Skylake-Client`

=== Memory Configuration

[source,yaml]
----
spec:
  template:
    spec:
      domain:
        memory:
          guest: 16Gi
          hugepages:
            pageSize: 2Mi
        resources:
          requests:
            memory: 16Gi
          limits:
            memory: 16Gi
----

**Memory Options:**

* `guest` - Memory visible to guest OS
* `hugepages` - Use huge pages for better performance
* `requests/limits` - Kubernetes resource management

== VM Verification

=== Check VM Status

[source,bash,role=execute]
----
# List VMs
oc get vm -n <namespace>

# List running VMs (VMIs)
oc get vmi -n <namespace>

# Get VM details
oc describe vm <vm-name> -n <namespace>

# Get VMI details  
oc describe vmi <vm-name> -n <namespace>

# Check VM events
oc get events -n <namespace> --field-selector involvedObject.name=<vm-name>
----

=== Access VM Console

[source,bash,role=execute]
----
# Text console
virtctl console <vm-name> -n <namespace>

# VNC console (requires port-forward)
virtctl vnc <vm-name> -n <namespace>

# RDP for Windows (requires service)
virtctl rdp <vm-name> -n <namespace>
----

=== Check VM Network

[source,bash,role=execute]
----
# Get VM IP addresses
oc get vmi <vm-name> -n <namespace> -o jsonpath='{.status.interfaces[*].ipAddress}'

# Get VM interface details
oc get vmi <vm-name> -n <namespace> -o jsonpath='{.status.interfaces[*]}'
----

== VM Best Practices

. **Use DataSources** for standard OS images
. **Set Appropriate Resources** based on workload
. **Use Labels** for organization and selection
. **Configure Cloud-init** for initialization
. **Test in Development** before production
. **Monitor Resource Usage** to right-size VMs
. **Use runStrategy** appropriately for workload type
. **Enable Guest Agent** for better integration

== Troubleshooting

=== VM Won't Start

**Check:**

[source,bash,role=execute]
----
# Check VM status
oc get vm <vm-name> -n <namespace> -o yaml

# Check events
oc get events -n <namespace> --field-selector involvedObject.name=<vm-name>

# Check virt-launcher pod
oc get pods -n <namespace> | grep virt-launcher
oc logs <virt-launcher-pod> -n <namespace>
----

**Common Causes:**

* Insufficient resources on nodes
* DataVolume not ready
* Invalid configuration
* Storage issues

=== VM Running But No Network

**Check:**

[source,bash,role=execute]
----
# Access console
virtctl console <vm-name> -n <namespace>

# Inside VM
ip addr show
ip route show
cat /etc/resolv.conf
----

**Common Causes:**

* Cloud-init network configuration error
* NAD not found
* Interface naming mismatch
* DHCP not working

=== VM Performance Issues

**Check:**

[source,bash,role=execute]
----
# Check resource usage
oc adm top pod <virt-launcher-pod> -n <namespace>

# Inside VM
top
free -h
df -h
----

**Solutions:**

* Increase CPU/memory
* Use VirtIO drivers
* Enable huge pages
* Check disk I/O

== Summary

Key VM manifest components:

* **DataVolumeTemplates**: Automatic storage provisioning
* **runStrategy**: Lifecycle management
* **domain**: Hardware configuration (CPU, memory, devices)
* **networks**: Network attachments
* **cloud-init**: Initialization configuration

== See Also

* xref:getting-started:virtctl-basics.adoc[Virtctl Basics]
* xref:networking.adoc[Network Configuration]
* xref:storage.adoc[Storage Configuration]
* xref:index.adoc[Manifests Reference Overview]
* link:https://docs.openshift.com/container-platform/latest/virt/virtual_machines/creating_vms_custom/virt-creating-vms-by-using-yaml.html[Creating VMs with YAML,window=_blank]

