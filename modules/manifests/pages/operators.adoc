= Operator Manifests
:navtitle: Operators

== Overview

This page provides YAML manifests for deploying and configuring essential operators for OpenShift Virtualization, including the LVM Storage Operator and NMState Operator.

== Prerequisites

* OpenShift 4.17+ cluster
* Cluster administrator access
* CLI tools: `oc`, `kubectl`

== LVM Storage Operator

The LVM Storage Operator provides local storage for OpenShift Virtualization using LVM (Logical Volume Manager).

=== Namespace Creation

First, create the required namespace:

[source,yaml]
----
apiVersion: v1
kind: Namespace
metadata:
  name: openshift-storage
  labels:
    openshift.io/cluster-monitoring: "true"
----

=== Operator Group

Create an OperatorGroup to manage the LVM operator:

[source,yaml]
----
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  name: openshift-storage-operatorgroup
  namespace: openshift-storage
spec:
  targetNamespaces:
  - openshift-storage
----

**Purpose:** Defines the namespace scope for the LVM operator.

**When to use:** Required before installing the LVM operator subscription.

=== Subscription

Subscribe to the LVM operator:

[source,yaml]
----
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: lvm-operator
  namespace: openshift-storage
spec:
  channel: stable-4.19
  name: lvm-operator
  source: redhat-operators
  sourceNamespace: openshift-marketplace
  installPlanApproval: Automatic
----

**Purpose:** Installs and manages the LVM Storage Operator.

**When to use:** After creating namespace and OperatorGroup.

**Note:** Update the `channel` field to match your OpenShift version.

=== Apply LVM Operator Manifests

[source,bash,role=execute]
----
# Create namespace
oc apply -f namespace.yaml

# Create OperatorGroup
oc apply -f operator-group.yaml

# Create Subscription
oc apply -f subscription.yaml

# Wait for operator to be ready
oc wait --for=condition=Ready pod -l app.kubernetes.io/name=lvm-operator -n openshift-storage --timeout=300s

# Verify installation
oc get csv -n openshift-storage
oc get pods -n openshift-storage
----

=== Related Tutorial

For complete LVM operator setup including LVMCluster configuration, see:

* xref:storage:lvm-operator.adoc[Installing LVM Storage Operator]
* xref:storage:lvm-troubleshooting.adoc[Troubleshooting LVM Storage]

== NMState Operator

The NMState Operator manages node network configuration, essential for configuring OVS bridges and network mappings for OpenShift Virtualization.

=== Installation

The NMState operator is typically pre-installed with OpenShift Virtualization. Verify installation:

[source,bash,role=execute]
----
# Check if NMState operator is installed
oc get csv -n openshift-nmstate

# Check NMState pods
oc get pods -n openshift-nmstate
----

If not installed, install from OperatorHub:

. Navigate to Operators > OperatorHub in OpenShift Console
. Search for "Kubernetes NMState Operator"
. Click Install
. Select "stable" channel
. Install in "openshift-nmstate" namespace

=== OVS Bridge Mapping Configuration

Configure OVS bridge mapping for localnet networks:

[source,yaml]
----
apiVersion: nmstate.io/v1
kind: NodeNetworkConfigurationPolicy
metadata:
  name: ovs-br-mapping
spec:
  nodeSelector:
    node-role.kubernetes.io/worker: ""
  desiredState:
    interfaces:
      - name: ens224
        description: Physical interface for OVS localnet
        type: ethernet
        state: up
        ipv4:
          enabled: false
        ipv6:
          enabled: false
    ovs-db:
      external_ids:
        ovn-bridge-mappings: "physnet1:br-ex"
        ovn-cms-options: "enable-chassis-as-gw"
----

**Purpose:** Maps physical network interface to OVS bridge for localnet topology.

**When to use:** Required for localnet secondary networks and VLAN configurations.

**Customization:**

* `name: ens224` - Update to your physical interface name (find with `ip link show`)
* `physnet1` - Logical network name (used in NAD configurations)
* `br-ex` - OVS bridge name (typically `br-ex`)

=== Verify OVS Bridge Configuration

[source,bash,role=execute]
----
# Check NodeNetworkConfigurationPolicy status
oc get nncp

# Get detailed status
oc describe nncp ovs-br-mapping

# Verify on nodes (requires debug pod)
oc debug node/<node-name>
chroot /host
ovs-vsctl show
ovs-vsctl get Open_vSwitch . external_ids:ovn-bridge-mappings
----

=== Related Tutorials

For network configuration using NMState, see:

* xref:networking:ovs-bridge-verification.adoc[Troubleshooting OVS Bridge Creation for Localnet Networks]
* xref:networking:localnet-secondary.adoc[Localnet Secondary Networks with CUDN]
* xref:networking:localnet-vlan.adoc[Localnet Secondary Networks with VLAN using NAD]

== OpenShift Virtualization Operator (CNV)

The OpenShift Virtualization (Container Native Virtualization) operator is the foundation for running VMs on OpenShift.

=== Installation

Install from OperatorHub:

. Navigate to Operators > OperatorHub in OpenShift Console
. Search for "OpenShift Virtualization"
. Click Install
. Select "stable" channel
. Install in "openshift-cnv" namespace
. Wait for installation to complete

=== Verify Installation

[source,bash,role=execute]
----
# Check operator status
oc get csv -n openshift-cnv

# Check HyperConverged CR
oc get hco -n openshift-cnv

# Check pods
oc get pods -n openshift-cnv

# Check available VM images
oc get datasource -n openshift-virtualization-os-images
----

=== HyperConverged Configuration

The HyperConverged custom resource configures OpenShift Virtualization:

[source,bash,role=execute]
----
# View current configuration
oc get hco kubevirt-hyperconverged -n openshift-cnv -o yaml
----

Key configuration options:

* Feature gates for experimental features
* Network configuration defaults
* Storage defaults
* Live migration settings

=== Related Information

For complete setup and usage:

* xref:getting-started:prerequisites.adoc[Prerequisites and Setup]
* xref:getting-started:virtctl-basics.adoc[Virtctl Basics]

== Operator Management

=== Check Operator Status

[source,bash,role=execute]
----
# List all operators
oc get csv -A

# Check specific operator
oc get csv -n openshift-cnv
oc get csv -n openshift-storage
oc get csv -n openshift-nmstate

# Check operator pods
oc get pods -n openshift-cnv
oc get pods -n openshift-storage
oc get pods -n openshift-nmstate
----

=== Update Operators

Operators with `installPlanApproval: Automatic` update automatically. For manual approval:

[source,bash,role=execute]
----
# List pending install plans
oc get installplan -n openshift-storage

# Approve install plan
oc patch installplan <install-plan-name> -n openshift-storage \
  --type merge --patch '{"spec":{"approved":true}}'
----

=== Troubleshooting Operators

[source,bash,role=execute]
----
# Check operator events
oc get events -n openshift-storage --sort-by='.lastTimestamp'

# Check operator logs
oc logs -n openshift-storage deployment/lvm-operator-controller-manager

# Check ClusterServiceVersion
oc describe csv -n openshift-storage
----

== Summary

Key operator manifests covered:

* **LVM Storage Operator**: Provides local storage using LVM
* **NMState Operator**: Manages node network configuration
* **OpenShift Virtualization**: Core virtualization platform

All operators work together to provide a complete virtualization platform with networking and storage capabilities.

== See Also

* xref:storage:lvm-operator.adoc[LVM Operator Installation Guide]
* xref:networking:ovs-bridge-verification.adoc[Troubleshooting OVS Bridge Creation for Localnet Networks]
* xref:index.adoc[Manifests Reference Overview]
* link:https://docs.openshift.com/container-platform/latest/operators/understanding/olm/olm-understanding-olm.html[Operator Lifecycle Manager,window=_blank]

