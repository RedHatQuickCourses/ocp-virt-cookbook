= Security Manifests
:navtitle: Security

== Overview

This page provides security-related YAML manifests for OpenShift Virtualization, including Network Policies, RBAC (Role-Based Access Control), and SCCs (Security Context Constraints).

== Network Policies

Network Policies control traffic flow between pods and VMs in OpenShift.

=== Allow All Traffic to VMs

[source,yaml]
----
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-all-to-vms
  namespace: vms-prod
spec:
  podSelector:
    matchLabels:
      kubevirt.io/domain: ""
  policyTypes:
    - Ingress
  ingress:
    - {}
----

**Purpose:** Allows all inbound traffic to VMs in namespace.

**When to use:** Development environments, testing, non-production.

NOTE: This is permissive. Use restrictive policies in production.

=== Allow Traffic from Specific Namespace

[source,yaml]
----
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-from-app-namespace
  namespace: vms-prod
spec:
  podSelector:
    matchLabels:
      kubevirt.io/domain: ""
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: app-frontend
----

**Purpose:** Allows traffic only from pods in `app-frontend` namespace.

**When to use:** Isolating VMs to specific application namespaces.

=== Allow Specific Ports

[source,yaml]
----
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-web-traffic
  namespace: vms-prod
spec:
  podSelector:
    matchLabels:
      app: webserver
      kubevirt.io/domain: ""
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 443
----

**Purpose:** Allows HTTP/HTTPS traffic to web server VMs.

**When to use:** Web-facing VMs requiring restricted access.

=== Deny All Traffic (Default Deny)

[source,yaml]
----
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: vms-prod
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
----

**Purpose:** Denies all traffic unless explicitly allowed by other policies.

**When to use:** Security-first approach, explicitly allow only required traffic.

NOTE: Add this first, then add specific allow policies as needed.

=== Allow DNS and SSH

[source,yaml]
----
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-and-ssh
  namespace: vms-prod
spec:
  podSelector:
    matchLabels:
      kubevirt.io/domain: ""
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 22
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              name: openshift-dns
      ports:
        - protocol: UDP
          port: 53
    - to:
        - podSelector: {}
----

**Purpose:** Allows SSH access and DNS resolution.

**Key Features:**

* SSH (port 22) ingress from any namespace
* DNS (port 53) egress to DNS namespace
* Allows egress to pods in same namespace

== RBAC (Role-Based Access Control)

RBAC controls who can perform actions on OpenShift resources.

=== VM Viewer Role

[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: vm-viewer
  namespace: vms-prod
rules:
  - apiGroups:
      - kubevirt.io
    resources:
      - virtualmachines
      - virtualmachineinstances
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - ""
    resources:
      - pods
      - services
    verbs:
      - get
      - list
----

**Purpose:** Read-only access to VMs in namespace.

**Permissions:**

* View VMs and VMIs
* View related pods and services
* No modify permissions

=== VM Operator Role

[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: vm-operator
  namespace: vms-prod
rules:
  - apiGroups:
      - kubevirt.io
    resources:
      - virtualmachines
      - virtualmachineinstances
    verbs:
      - get
      - list
      - watch
      - create
      - delete
      - update
      - patch
  - apiGroups:
      - subresources.kubevirt.io
    resources:
      - virtualmachines/start
      - virtualmachines/stop
      - virtualmachines/restart
    verbs:
      - update
  - apiGroups:
      - ""
    resources:
      - persistentvolumeclaims
    verbs:
      - get
      - list
      - create
  - apiGroups:
      - cdi.kubevirt.io
    resources:
      - datavolumes
    verbs:
      - get
      - list
      - create
----

**Purpose:** Full VM lifecycle management within namespace.

**Permissions:**

* Create, modify, delete VMs
* Start, stop, restart VMs
* Create PVCs and DataVolumes
* View resources

=== VM Admin Role

[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: vm-admin
  namespace: vms-prod
rules:
  - apiGroups:
      - ""
      - kubevirt.io
      - cdi.kubevirt.io
      - k8s.cni.cncf.io
    resources:
      - "*"
    verbs:
      - "*"
----

**Purpose:** Full administrative access to all VM-related resources in namespace.

NOTE: Very permissive. Use sparingly and only for administrators.

=== Role Binding

Bind roles to users or groups:

[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: vm-operators-binding
  namespace: vms-prod
subjects:
  - kind: User
    name: alice@example.com
    apiGroup: rbac.authorization.k8s.io
  - kind: Group
    name: vm-operators
    apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: vm-operator
  apiGroup: rbac.authorization.k8s.io
----

**Purpose:** Grants `vm-operator` role to user Alice and group vm-operators.

=== ClusterRole for VM Management Across Namespaces

[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cluster-vm-operator
rules:
  - apiGroups:
      - kubevirt.io
    resources:
      - virtualmachines
      - virtualmachineinstances
    verbs:
      - get
      - list
      - watch
      - create
      - delete
      - update
      - patch
  - apiGroups:
      - subresources.kubevirt.io
    resources:
      - virtualmachines/start
      - virtualmachines/stop
      - virtualmachines/restart
    verbs:
      - update
----

**Purpose:** VM management permissions across all namespaces.

**Binding:**

[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cluster-vm-operators-binding
subjects:
  - kind: Group
    name: platform-team
    apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: cluster-vm-operator
  apiGroup: rbac.authorization.k8s.io
----

== Security Context Constraints (SCCs)

SCCs control pod security policies in OpenShift.

=== VM Privileged SCC

OpenShift Virtualization VMs require specific SCCs. The operator automatically creates required SCCs.

Check VM-related SCCs:

[source,bash,role=execute]
----
# List SCCs
oc get scc | grep kubevirt

# View specific SCC
oc describe scc kubevirt-controller
----

**Pre-configured SCCs:**

* `kubevirt-controller` - For virt-controller
* `kubevirt-handler` - For virt-handler
* `hostmount-anyuid` - For VM launcher pods

NOTE: Generally, you don't need to create custom SCCs for VMs. The operator handles this.

=== Custom SCC for Specific VM Workloads

If needed, create custom SCC:

[source,yaml]
----
apiVersion: security.openshift.io/v1
kind: SecurityContextConstraints
metadata:
  name: vm-custom-scc
allowPrivilegedContainer: false
allowHostDirVolumePlugin: false
allowHostIPC: false
allowHostNetwork: false
allowHostPID: false
allowHostPorts: false
readOnlyRootFilesystem: false
runAsUser:
  type: RunAsAny
seLinuxContext:
  type: MustRunAs
fsGroup:
  type: RunAsAny
supplementalGroups:
  type: RunAsAny
volumes:
  - configMap
  - downwardAPI
  - emptyDir
  - persistentVolumeClaim
  - projected
  - secret
----

**When to use:** Custom security requirements beyond default VM SCCs.

== Service Accounts

Service accounts for VM management automation.

=== VM Management Service Account

[source,yaml]
----
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vm-manager
  namespace: vms-prod
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: vm-manager-binding
  namespace: vms-prod
subjects:
  - kind: ServiceAccount
    name: vm-manager
    namespace: vms-prod
roleRef:
  kind: Role
  name: vm-operator
  apiGroup: rbac.authorization.k8s.io
----

**Purpose:** Service account for automated VM management.

**Use cases:**

* CI/CD pipelines
* Automation scripts
* Monitoring tools

== Security Best Practices

. **Principle of Least Privilege**
+
Grant minimum necessary permissions.

. **Network Segmentation**
+
Use Network Policies to isolate VM workloads.

. **Regular Audits**
+
Review RBAC assignments periodically.

. **Service Account Management**
+
Use service accounts for automation, not user credentials.

. **Default Deny**
+
Start with deny-all Network Policy, then allow specific traffic.

. **Namespace Isolation**
+
Use separate namespaces for different environments.

. **Secrets Management**
+
Don't hardcode passwords in cloud-init userData.

. **SSH Key Authentication**
+
Use SSH keys instead of passwords for VM access.

== Verification

=== Check Network Policies

[source,bash,role=execute]
----
# List Network Policies
oc get networkpolicy -n vms-prod

# Describe specific policy
oc describe networkpolicy <policy-name> -n vms-prod

# Check if policy applies to specific pod
oc get pod <virt-launcher-pod> -n vms-prod --show-labels
----

=== Check RBAC Permissions

[source,bash,role=execute]
----
# Check what user can do
oc auth can-i create vm -n vms-prod --as=alice@example.com

# Check all permissions for user
oc auth can-i --list -n vms-prod --as=alice@example.com

# View role bindings
oc get rolebinding -n vms-prod
oc describe rolebinding <binding-name> -n vms-prod
----

=== Check Service Accounts

[source,bash,role=execute]
----
# List service accounts
oc get serviceaccount -n vms-prod

# Get service account token
oc sa get-token vm-manager -n vms-prod

# Check service account permissions
oc auth can-i --list --as=system:serviceaccount:vms-prod:vm-manager -n vms-prod
----

=== Check SCCs

[source,bash,role=execute]
----
# List SCCs
oc get scc

# Check which SCC is used by pod
oc get pod <virt-launcher-pod> -n vms-prod -o yaml | grep "openshift.io/scc"

# Describe SCC
oc describe scc kubevirt-controller
----

== Troubleshooting

=== Permission Denied Errors

**Error:**

```
Error from server (Forbidden): User "alice@example.com" cannot create resource "virtualmachines"
```

**Solution:**

[source,bash,role=execute]
----
# Check user permissions
oc auth can-i create vm -n vms-prod --as=alice@example.com

# Check role bindings
oc get rolebinding -n vms-prod

# Add role binding if missing
oc create rolebinding alice-vm-operator \
  --role=vm-operator \
  --user=alice@example.com \
  -n vms-prod
----

=== Network Policy Blocking Traffic

**Symptoms:** VM cannot communicate despite correct network configuration.

**Check:**

[source,bash,role=execute]
----
# List network policies
oc get networkpolicy -n vms-prod

# Check if policy matches VM pod
oc get vmi <vm-name> -n vms-prod -o yaml | grep labels -A 5

# Temporarily remove policy to test
oc delete networkpolicy <policy-name> -n vms-prod
----

=== SCC Issues

**Error:**

```
unable to validate against any security context constraint
```

**Solution:**

[source,bash,role=execute]
----
# Check available SCCs
oc get scc | grep kubevirt

# Verify operator installation
oc get csv -n openshift-cnv

# Check virt-controller logs
oc logs -n openshift-cnv deployment/virt-controller
----

== Summary

Key security manifest types:

* **Network Policies**: Control traffic flow between VMs and pods
* **Roles/RoleBindings**: Control who can manage VMs
* **ClusterRoles**: Cluster-wide permissions
* **Service Accounts**: For automation and integration
* **SCCs**: Pod security policies (mostly automatic)

Security approach:

. Start with least privilege
. Use Network Policies for isolation
. Grant RBAC permissions as needed
. Use service accounts for automation
. Regular security audits

== See Also

* xref:index.adoc[Manifests Reference Overview]
* link:https://docs.openshift.com/container-platform/latest/authentication/using-rbac.html[OpenShift RBAC,window=_blank]
* link:https://docs.openshift.com/container-platform/latest/authentication/managing-security-context-constraints.html[Security Context Constraints,window=_blank]
* link:https://docs.openshift.com/container-platform/latest/networking/network_policy/about-network-policy.html[Network Policies,window=_blank]

