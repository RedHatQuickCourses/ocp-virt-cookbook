<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Configuring Localnet Secondary Networks with VLAN using NetworkAttachmentDefinition in OpenShift Virtualization :: OpenShift Virtualization cookbook</title>
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">OpenShift Virtualization cookbook</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/ocp-virt-cookbook/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ocp-virt-cookbook" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">OpenShift Virtualization cookbook</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../index.html">Home</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../getting-started/index.html">Getting Started</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../storage/index.html">Storage Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html">Networking Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../vm-configuration/index.html">Virtual Machine Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../manifests/index.html">Manifests Reference</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../LABENV/index.html">Lab Environment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../appendix/glossary.html">Glossary</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OpenShift Virtualization cookbook</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">OpenShift Virtualization cookbook</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">OpenShift Virtualization cookbook</a></li>
    <li><a href="localnet-vlan.html">Configuring Localnet Secondary Networks with VLAN using NetworkAttachmentDefinition in OpenShift Virtualization</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Configuring Localnet Secondary Networks with VLAN using NetworkAttachmentDefinition in OpenShift Virtualization</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This tutorial demonstrates how to configure localnet secondary networks with VLAN tagging using NetworkAttachmentDefinition (NAD) in OpenShift Virtualization. This approach provides direct access to physical network infrastructure with VLAN segmentation, enabling VMs to communicate with specific VLAN-tagged networks while maintaining pod network connectivity. This is ideal for integrating with existing VLAN-based network infrastructure or when network segmentation is required.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><strong>NMState Operator</strong>: Must be installed and running in the cluster</p>
</li>
<li>
<p><strong>NMState CR</strong>: The nmstate instance must be created after the operator is running</p>
</li>
<li>
<p><strong>Worker nodes</strong>: The bridge mapping will be applied to worker nodes</p>
</li>
<li>
<p><strong>VLAN Infrastructure</strong>: Physical network infrastructure must support VLAN tagging</p>
</li>
<li>
<p><strong>Switch Configuration</strong>: Physical switch ports connected to OpenShift worker nodes must be configured in <strong>trunk mode</strong> to handle multiple VLAN-tagged traffic streams</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Versions tested:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OCP 4.19</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_network_configuration_requirements"><a class="anchor" href="#_network_configuration_requirements"></a>Network Configuration Requirements</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_physical_switch_configuration_trunk_mode"><a class="anchor" href="#_physical_switch_configuration_trunk_mode"></a>Physical Switch Configuration: TRUNK MODE</h3>
<div class="paragraph">
<p>The physical switch ports connected to OpenShift worker nodes <strong>must be configured in trunk mode</strong> for localnet VLAN configuration to work properly:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Trunk mode</strong>: Allows switch ports to carry traffic for multiple VLANs</p>
</li>
<li>
<p><strong>VLAN tagging</strong>: Each VLAN is identified by its unique VLAN ID (e.g., 100, 200, 300)</p>
</li>
<li>
<p><strong>Multiple networks</strong>: Essential for supporting multiple VLAN-based secondary networks</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_1_create_vm_namespace"><a class="anchor" href="#_step_1_create_vm_namespace"></a>Step 1: Create VM Namespace</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create a namespace for VMs that will use the localnet secondary network with VLAN configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">oc apply -f - &lt;&lt;EOF
apiVersion: v1
kind: Namespace
metadata:
  name: vm-guests-vlan
EOF</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_2_configure_bridge_mapping"><a class="anchor" href="#_step_2_configure_bridge_mapping"></a>Step 2: Configure Bridge Mapping</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Configure the bridge mapping that connects the logical network interface name <code>localnet-vlan</code> to the <code>br-ex</code> bridge interface on worker nodes. This mapping tells OVN-Kubernetes which physical bridge interface handles localnet traffic with VLAN support, enabling VM access to VLAN-tagged external networks through the underlying physical network infrastructure.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">oc apply -f - &lt;&lt;EOF
apiVersion: nmstate.io/v1
kind: NodeNetworkConfigurationPolicy
metadata:
  name: localnet-vlan-bridge-mapping
spec:
  nodeSelector:
    node-role.kubernetes.io/worker: ''
  desiredState:
    ovn:
      bridge-mappings:
      - localnet: localnet-vlan
        bridge: br-ex
        state: present
EOF</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_3_create_networkattachmentdefinition_with_vlan"><a class="anchor" href="#_step_3_create_networkattachmentdefinition_with_vlan"></a>Step 3: Create NetworkAttachmentDefinition with VLAN</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create a NetworkAttachmentDefinition that configures localnet topology with VLAN tagging for secondary network connectivity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">oc apply -f - &lt;&lt;EOF
apiVersion: "k8s.cni.cncf.io/v1"
kind: NetworkAttachmentDefinition
metadata:
  name: localnet-vlan-100
  namespace: vm-guests-vlan
spec:
  config: '{
    "cniVersion": "0.3.1",
    "name": "localnet-vlan-100",
    "type": "ovn-k8s-cni-overlay",
    "topology": "localnet",
    "netAttachDefName": "vm-guests-vlan/localnet-vlan-100",
    "vlanID": 100,
    "subnets": "192.168.100.0/24",
    "excludeSubnets": "192.168.100.1/32"
  }'
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Configuration Details</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>vlanID: 100</code>: Specifies VLAN tag 100 for network segmentation</p>
</li>
<li>
<p><code>subnets</code>: Defines the expected IP subnet range for documentation and validation purposes</p>
</li>
<li>
<p><code>excludeSubnets</code>: Excludes gateway IP from being assigned (typically reserved for router/gateway)</p>
</li>
<li>
<p><code>topology: "localnet"</code>: Uses localnet topology for direct physical network access</p>
</li>
<li>
<p><strong>No IPAM configuration</strong>: IP addresses require external DHCP server on the VLAN network or VMs need to be configured statically</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_4_deploy_vm_with_vlan_network_connectivity"><a class="anchor" href="#_step_4_deploy_vm_with_vlan_network_connectivity"></a>Step 4: Deploy VM with VLAN Network Connectivity</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create a VM that connects to both the pod network and the VLAN-tagged localnet secondary network.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">oc apply -f - &lt;&lt;EOF
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: fedora-vlan-vm
  namespace: vm-guests-vlan
  labels:
    app: fedora-vlan-vm
spec:
  runStrategy: Always
  dataVolumeTemplates:
  - metadata:
      name: fedora-vlan-volume
    spec:
      pvc:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 33Gi
      sourceRef:
        kind: DataSource
        name: fedora
        namespace: openshift-virtualization-os-images
  template:
    metadata:
      labels:
        app: fedora-vlan-vm
    spec:
      domain:
        devices:
          disks:
          - name: datavolumedisk
            disk:
              bus: virtio
          - name: cloudinitdisk
            disk:
              bus: virtio
          interfaces:
          - name: default
            bridge: {}
          - name: vlan_network
            bridge: {}
        resources:
          requests:
            memory: 2Gi
            cpu: 1
      networks:
      - name: default
        pod: {}
      - name: vlan_network
        multus:
          networkName: localnet-vlan-100
      volumes:
      - name: datavolumedisk
        dataVolume:
          name: fedora-vlan-volume
      - name: cloudinitdisk
        cloudInitNoCloud:
          userData: |
            #cloud-config
            user: fedora
            password: fedora
            chpasswd: { expire: False }
            packages:
            - python3
            - tcpdump
            - net-tools
            runcmd:
            - echo "&lt;h1&gt;Welcome to OpenShift Virtualization VLAN Network!&lt;/h1&gt;" &gt; /root/index.html
            - echo "&lt;p&gt;VLAN ID: 100&lt;/p&gt;" &gt;&gt; /root/index.html
            - echo "&lt;p&gt;Network: 192.168.100.0/24&lt;/p&gt;" &gt;&gt; /root/index.html
            - cd /root &amp;&amp; nohup python3 -m http.server 8080 &gt; /dev/null 2&gt;&amp;1 &amp;
EOF</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_5_verify_vlan_network_connectivity"><a class="anchor" href="#_step_5_verify_vlan_network_connectivity"></a>Step 5: Verify VLAN Network Connectivity</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Access the VM console to verify dual network connectivity with VLAN configuration.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># Check the VM status
oc get vm -n vm-guests-vlan

# Check the running VM instance
oc get vmi -n vm-guests-vlan

# Access the VM console (credentials: fedora/fedora via cloud-init)
virtctl console -n vm-guests-vlan fedora-vlan-vm</code></pre>
</div>
</div>
<div class="paragraph">
<p>Inside the VM console, verify the VLAN network configuration:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># Check network interfaces - primary (pod network) and secondary (VLAN network)
ip addr show

# Check routes - two default gateways (lower metric prioritized)
# Primary network: metric 100, Secondary VLAN: metric 101
ip route show

# Expected output example:
default via 10.128.0.1 dev enp1s0 proto dhcp src 10.128.0.172 metric 100
default via 192.168.100.1 dev enp2s0 proto dhcp src 192.168.100.50 metric 101

# Test external connectivity
ping 8.8.8.8

# Verify the web service is running
curl localhost:8080

# Test VLAN interface connectivity (replace &lt;vlan-ip&gt; with actual IP)
curl &lt;vlan-ip&gt;:8080

# Verify VLAN tagging (if tcpdump is available)
# This will show VLAN-tagged traffic on the secondary interface
sudo tcpdump -i enp2s0 -nn vlan 100</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_troubleshooting"><a class="anchor" href="#_troubleshooting"></a>Troubleshooting</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_common_issues"><a class="anchor" href="#_common_issues"></a>Common Issues</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>VLAN Traffic Not Reaching VM</strong>:</p>
<div class="ulist">
<ul>
<li>
<p>Verify physical switch configuration supports VLAN tagging</p>
</li>
<li>
<p>Check bridge mapping configuration on worker nodes</p>
</li>
<li>
<p>Ensure VLAN ID matches network infrastructure</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>IP Address Assignment Issues</strong>:</p>
<div class="ulist">
<ul>
<li>
<p>Verify DHCP server is available on the VLAN network</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Network Connectivity Problems</strong>:</p>
<div class="ulist">
<ul>
<li>
<p>Check that the physical network supports the configured VLAN</p>
</li>
<li>
<p>Test connectivity from physical network to VLAN subnet</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_verification_commands"><a class="anchor" href="#_verification_commands"></a>Verification Commands</h3>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># Check NetworkAttachmentDefinition status
oc get network-attachment-definitions -n vm-guests-vlan

# Verify bridge mapping on worker nodes
oc get nncp localnet-vlan-bridge-mapping -o yaml

# Check VM network status
oc get vmi -n vm-guests-vlan -o yaml | grep -A 10 networks

# View OVN-Kubernetes logs for troubleshooting
oc logs -n openshift-ovn-kubernetes -l app=ovnkube-node</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references"><a class="anchor" href="#_references"></a>References</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_openshift_documentation"><a class="anchor" href="#_openshift_documentation"></a>OpenShift Documentation</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.redhat.com/en/documentation/openshift_container_platform/4.19/html/multiple_networks/understanding-multiple-networks" target="_blank" rel="noopener">OpenShift - Understanding Multiple Networks</a></p>
</li>
<li>
<p><a href="https://docs.redhat.com/en/documentation/openshift_container_platform/4.19/html/virtualization/networking#virt-creating-secondary-localnet-udn_virt-connecting-vm-to-secondary-udn" target="_blank" rel="noopener">Localnet Topology Configuration for OCP Virtualization</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
