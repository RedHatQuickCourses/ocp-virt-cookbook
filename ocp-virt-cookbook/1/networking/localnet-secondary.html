<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Configuring Localnet Secondary Networks with ClusterUserDefinedNetwork in OpenShift Virtualization :: OpenShift Virtualization cookbook</title>
    <link rel="prev" href="udn-primary-networks.html">
    <link rel="next" href="localnet-vlan.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">OpenShift Virtualization cookbook</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/ocp-virt-cookbook/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ocp-virt-cookbook" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">OpenShift Virtualization cookbook</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../getting-started/index.html">Getting Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../getting-started/prerequisites.html">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../getting-started/virtctl-basics.html">Virtctl Basics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../getting-started/default-storage-class.html">Storage Setup</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../storage/index.html">Storage Configuration</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../storage/lvm-operator.html">LVM Operator Installation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../storage/lvm-troubleshooting.html">LVM Troubleshooting</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Networking Configuration</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="udn-primary-networks.html">UDN Primary Networks</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="localnet-secondary.html">Localnet Secondary Networks with CUDN</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="localnet-vlan.html">Localnet Secondary Networks with VLAN using NAD</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cudn-localnet-vlan.html">Localnet VLAN with CUDN</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="linux-bridges.html">Linux Bridges</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ovs-bridge-troubleshooting.html">Troubleshooting OVS Bridge Creation for Localnet Networks</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../vm-configuration/index.html">Virtual Machine Configuration</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../vm-configuration/cloud-init-ip-configuration.html">Cloud-init IP Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../vm-configuration/cloud-init-troubleshooting.html">Cloud-init Troubleshooting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../vm-configuration/internal-dns-for-vms.html">Internal DNS for VMs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../vm-configuration/remote-access-linux-vms.html">Remote Access to Linux VMs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../vm-configuration/remote-access-linux-troubleshooting.html">Remote Access to Linux VMs Troubleshooting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../vm-configuration/remote-access-windows-vms.html">Remote Access to Windows VMs via RDP</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../vm-configuration/custom-golden-images.html">Custom Golden Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../vm-configuration/golden-images-troubleshooting.html">Golden Images Troubleshooting</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../manifests/index.html">YAML Manifests Reference</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../manifests/operators.html">Operators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../manifests/networking.html">Networking</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../manifests/storage.html">Storage</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../manifests/vms.html">Virtual Machines</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../manifests/security.html">Security</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../lab-env/index.html">Lab Environment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../appendix/glossary.html">Glossary</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OpenShift Virtualization cookbook</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">OpenShift Virtualization cookbook</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">OpenShift Virtualization cookbook</a></li>
    <li><a href="index.html">Networking Configuration</a></li>
    <li><a href="localnet-secondary.html">Localnet Secondary Networks with CUDN</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Configuring Localnet Secondary Networks with ClusterUserDefinedNetwork in OpenShift Virtualization</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This tutorial demonstrates how to configure localnet secondary networks using ClusterUserDefinedNetwork (CUDN) in OpenShift Virtualization. Localnet topology provides direct access to physical network infrastructure, enabling VMs to communicate with external networks while maintaining pod network connectivity. This approach is ideal for integrating with existing infrastructure or legacy systems requiring layer 2 connectivity.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><strong>NMState Operator</strong>: Must be installed and running in the cluster</p>
</li>
<li>
<p><strong>NMState CR</strong>: The nmstate instance must be created after the operator is running</p>
</li>
<li>
<p><strong>Worker nodes</strong>: The bridge mapping will be applied to worker nodes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Versions tested:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OpenShift 4.19</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_1_create_vm_namespace"><a class="anchor" href="#_step_1_create_vm_namespace"></a>Step 1: Create VM Namespace</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create a namespace for VMs that will use the localnet secondary network.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">oc apply -f - &lt;&lt;EOF
apiVersion: v1
kind: Namespace
metadata:
  name: vm-guests-localnet
EOF</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_2_configure_bridge_mapping"><a class="anchor" href="#_step_2_configure_bridge_mapping"></a>Step 2: Configure Bridge Mapping</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Configure the bridge mapping that connects the logical physnet name to the <code>br-ex</code> bridge interface. This tells OVN-Kubernetes which physical interface handles localnet traffic.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">oc apply -f - &lt;&lt;EOF
apiVersion: nmstate.io/v1
kind: NodeNetworkConfigurationPolicy
metadata:
  name: localnet-bridge-mapping
spec:
  nodeSelector:
    node-role.kubernetes.io/worker: ''
  desiredState:
    ovn:
      bridge-mappings:
      - localnet: localnet1
        bridge: br-ex
        state: present
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note</strong>: This maps the logical <code>localnet1</code> name to the <code>br-ex</code> bridge on worker nodes, enabling VM access to external networks.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_3_create_clusteruserdefinednetwork"><a class="anchor" href="#_step_3_create_clusteruserdefinednetwork"></a>Step 3: Create ClusterUserDefinedNetwork</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create a ClusterUserDefinedNetwork with localnet topology for secondary network connectivity to external networks.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">oc apply -f - &lt;&lt;EOF
apiVersion: k8s.ovn.org/v1
kind: ClusterUserDefinedNetwork
metadata:
  name: cudn-localnet
spec:
  namespaceSelector:
    matchExpressions:
    - key: kubernetes.io/metadata.name
      operator: In
      values: ["vm-guests-localnet"]
  network:
    topology: Localnet
    localnet:
        role: Secondary
        physicalNetworkName: localnet1
        ipam:
          mode: Disabled
EOF</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_4_deploy_vm_with_dual_network_connectivity"><a class="anchor" href="#_step_4_deploy_vm_with_dual_network_connectivity"></a>Step 4: Deploy VM with Dual Network Connectivity</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create a VM that connects to both the pod network and the localnet secondary network for dual connectivity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">oc apply -f - &lt;&lt;EOF
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: fedora-localnet-vm
  namespace: vm-guests-localnet
  labels:
    app: fedora-localnet-vm
spec:
  runStrategy: Always
  dataVolumeTemplates:
  - metadata:
      name: fedora-localnet-volume
    spec:
      pvc:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 33Gi
      sourceRef:
        kind: DataSource
        name: fedora
        namespace: openshift-virtualization-os-images
  template:
    metadata:
      labels:
        app: fedora-localnet-vm
    spec:
      domain:
        devices:
          disks:
          - name: datavolumedisk
            disk:
              bus: virtio
          - name: cloudinitdisk
            disk:
              bus: virtio
          interfaces:
          - name: default
            bridge: {}
          - name: secondary_localnet
            bridge: {}
        resources:
          requests:
            memory: 2Gi
            cpu: 1
      networks:
      - name: default
        pod: {}
      - name: secondary_localnet
        multus:
          networkName: cudn-localnet
      volumes:
      - name: datavolumedisk
        dataVolume:
          name: fedora-localnet-volume
      - name: cloudinitdisk
        cloudInitNoCloud:
          userData: |
            #cloud-config
            user: fedora
            password: fedora
            chpasswd: { expire: False }
            packages:
            - python3
            runcmd:
            - echo "&lt;h1&gt;Welcome to OpenShift Virtualization Localnet!&lt;/h1&gt;" &gt; /root/index.html
            - cd /root &amp;&amp; nohup python3 -m http.server 8080 &gt; /dev/null 2&gt;&amp;1 &amp;
EOF</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_step_5_verify_network_connectivity"><a class="anchor" href="#_step_5_verify_network_connectivity"></a>Step 5: Verify Network Connectivity</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Access the VM console to verify dual network connectivity.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># Check the VM status
oc get vm -n vm-guests-localnet

# Check the running VM instance
oc get vmi -n vm-guests-localnet

# Access the VM console (credentials: fedora/fedora via cloud-init)
virtctl console -n vm-guests-localnet fedora-localnet-vm</code></pre>
</div>
</div>
<div class="paragraph">
<p>Inside the VM console, verify the network configuration:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># Check network interfaces - primary (pod network) and secondary (localnet)
ip addr show

# Check routes - two default gateways (lower metric prioritized)
# Primary network: metric 100, Secondary: metric 101
ip route show

# Expected output example:

default via 10.128.0.1 dev enp1s0 proto dhcp src 10.128.0.172 metric 100
default via 192.168.2.1 dev enp2s0 proto dhcp src 192.168.2.128 metric 101

# Test external connectivity
ping 8.8.8.8

# Verify the web service is running
curl localhost:8080

# Test localnet interface connectivity (replace &lt;localnet-ip&gt; with actual IP)
curl &lt;localnet-ip&gt;:8080</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references"><a class="anchor" href="#_references"></a>References</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_openshift_documentation"><a class="anchor" href="#_openshift_documentation"></a>OpenShift Documentation</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.redhat.com/en/documentation/openshift_container_platform/4.19/html/multiple_networks/understanding-multiple-networks" target="_blank" rel="noopener">OpenShift - Understanding Multiple Networks</a></p>
</li>
<li>
<p><a href="https://docs.redhat.com/en/documentation/openshift_container_platform/4.19/html/virtualization/networking#virt-creating-secondary-localnet-udn_virt-connecting-vm-to-secondary-udn" target="_blank" rel="noopener">Localnet Topology Configuration for OCP Virtualization</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="udn-primary-networks.html">UDN Primary Networks</a></span>
  <span class="next"><a href="localnet-vlan.html">Localnet Secondary Networks with VLAN using NAD</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
